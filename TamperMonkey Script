// ==UserScript==
// @name         Open_Genius_For_YoutubeMusic
// @namespace    http://tampermonkey.net/
// @version      3.2
// @description  Automatically opens the Genius page from YouTube and adjusts the Genius layout and adds a dark mode toggle for Genius.
// @author       Ace
// @match        https://www.youtube.com/watch*
// @match        https://genius.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @grant        GM_addValueChangeListener
// @connect      raw.githubusercontent.com
// ==/UserScript==

(function() {
    'use strict';

    const host = window.location.host;

    // ---------------------
    // Code for YouTube pages
    // ---------------------
    if (host.includes('youtube.com')) {
        const CSV_URL = 'https://raw.githubusercontent.com/188751671/Open_Genius_For_YoutubeMusic/refs/heads/main/videoID_To_GeniusURL.csv';
        const CHECK_INTERVAL = 2000; // 2 seconds
        let processedVideoId = null;

        const CACHE_KEY = 'geniusMapping';
        const CACHE_TIMESTAMP_KEY = 'lastRetrivalTime';
        const CACHE_LIFETIME = 10 * 60 * 1000; // 10 minutes

        function extractVideoId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('v');
        }

        function getCachedMapping(callback) {
            let cachedMapping = GM_getValue(CACHE_KEY, null);
            let timestamp = GM_getValue(CACHE_TIMESTAMP_KEY, 0);
            let now = Date.now();

            if (cachedMapping && (now - timestamp < CACHE_LIFETIME)) {
                console.log('Using Cached CSV');
                callback(cachedMapping);
            } else {
                GM_xmlhttpRequest({
                    method: 'GET',
                    url: CSV_URL,
                    onload: function(response) {
                        console.log('New Retrieved CSV:', response.responseText);
                        try {
                            const data = parseCSV(response.responseText, true);
                            GM_setValue(CACHE_KEY, data);
                            GM_setValue(CACHE_TIMESTAMP_KEY, now);
                            callback(data);
                        } catch (e) {
                            console.error('Error parsing CSV:', e);
                        }
                    },
                    onerror: function(error) {
                        console.error('Error fetching mapping:', error);
                    }
                });
            }
        }

        function parseCSV(csvString, skipHeader = false) {
            let rows = csvString
                .trim()
                .split("\n")
                .map(row => row.trim())
                .filter(row => row !== "")
                .map(row => row.split(",").map(item => item.trim()));

            return skipHeader ? rows.slice(1) : rows;
        }

        function openGeniusPage(url) {
            // Always target the named tab instead of keeping a fragile in-memory handle.
            const geniusWindow = window.open('', 'genius_tab');
            if (geniusWindow) {
                geniusWindow.location.replace(url);
                // return focus to the current (YouTube) tab
                window.focus();
            } else {
                console.warn('Could not open or retarget genius_tab (popup may be blocked).');
            }
        }



        function getGeniusUrl(csvArray, videoId) {
            const foundRow = csvArray.find(row => row[0] === videoId);
            return foundRow ? `https://genius.com/${foundRow[1]}` : null;
        }

        function checkAndOpenLyrics() {
            let currentVideoId = extractVideoId();
            console.log('Retrieved YouTube ID:', currentVideoId);

            if (!currentVideoId || currentVideoId === processedVideoId) return;
            processedVideoId = currentVideoId;

            getCachedMapping(function(mapping) {
                const geniusUrl = getGeniusUrl(mapping, currentVideoId);
                if (geniusUrl) {
                    console.log('Retrieved Genius URL:', geniusUrl);
                    openGeniusPage(geniusUrl);
                } else {
                    console.warn('Video ID not found in CSV, not opening Genius.');
                }
            });
        }

        GM_registerMenuCommand('Toggle Genius Dark Mode', () => {
            GM_setValue('darkModeChangedSignal', Date.now());
        });

        console.log('YouTube Script is starting...');
        setInterval(checkAndOpenLyrics, CHECK_INTERVAL);
    }

    // ---------------------
    // Code for Genius pages
    // ---------------------
    else if (host.includes('genius.com')) {
        // set the tab name again. Sometimes we navigate on the Genius page and it changes the window name.
        window.name = 'genius_tab';

        const style = document.createElement('style');
        style.textContent = `
        /* 极简：单列居中，聚焦歌词 */
        #lyrics-root {
            max-width: 760px !important;
            margin: 0 auto !important;
            padding: 0 16px !important;
        }

        /* 让歌词本体占满 */
        #lyrics-root [data-lyrics-container="true"] {
            max-width: none !important;
            width: 100% !important;
        }

        /* 隐藏右侧栏与各类广告 */
        #lyrics-root > [class*="RightSidebar__Container"],
        [data-exclude-from-selection="true"],
        inread-ad,
        [id^="div-gpt-ad-"] {
            display: none !important;
        }
        `;
        document.head.appendChild(style);

        // ---------------------
        // Auto jump to lyrics
        // ---------------------
        let didScrollToLyrics = false;
        const tryScrollToLyrics = () => {
            if (didScrollToLyrics) return true;
            const target = document.querySelector('#lyrics') ||
                           document.querySelector('[data-lyrics-container="true"]');
            if (!target) return false;
            const top = target.getBoundingClientRect().top + window.scrollY - 12;
            window.scrollTo({ top, behavior: 'auto' });
            didScrollToLyrics = true;
            return true;
        };

        if (!tryScrollToLyrics()) {
            const observer = new MutationObserver(() => {
                if (tryScrollToLyrics()) observer.disconnect();
            });
            observer.observe(document.body, { childList: true, subtree: true });
            setTimeout(() => { tryScrollToLyrics(); }, 4000);
        }

        // ---------------------
        // Dark Mode Toggle
        // ---------------------
        const darkModeStyles = `
            body { background-color: #292929; color: #BAB7BA; }
            .header { background-color: #1f1f1f; }
            .jAzSMw, .cNCMgo { background-color: #333333!important; color: #BAB7BA; }
            .cNXXxk, .dddWnX, .hwdUNy { color: #BAB7BA !important; }
        `;
        const darkModeStyleElement = document.createElement('style');
        darkModeStyleElement.textContent = darkModeStyles;


        // Executed code every time page opens
        let darkModeEnabled = GM_getValue('darkMode', false);
        function applyDarkMode(state) {
            if (state) {
                document.head.appendChild(darkModeStyleElement);
            } else {
                if (darkModeStyleElement.parentNode) {
                    darkModeStyleElement.parentNode.removeChild(darkModeStyleElement);
                }
            }
        }
        applyDarkMode(darkModeEnabled);




        function toggleDarkMode(){
            const nextState = !GM_getValue('darkMode', false);
            GM_setValue('darkMode', nextState);
            applyDarkMode(nextState);
            console.log(`Genius Dark Mode ${nextState ? 'enabled' : 'disabled'}.`);
        }

        // UI Button regis, not executed code
        GM_registerMenuCommand('Toggle Dark Mode', () => {
            toggleDarkMode();
        });

        // listen to Youtube's Toggle button
        GM_addValueChangeListener('darkModeChangedSignal', () => {
            toggleDarkMode();
        });
    }

})();
