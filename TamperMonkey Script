// ==UserScript==
// @name         Open_Genius_For_YoutubeMusic
// @namespace    http://tampermonkey.net/
// @version      3.0
// @description  Automatically opens the Genius page from YouTube and adjusts the Genius layout and adds a dark mode toggle for Genius.
// @author       Ace
// @match        https://www.youtube.com/watch*
// @match        https://genius.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @connect      raw.githubusercontent.com
// ==/UserScript==

(function() {
    'use strict';

    const host = window.location.host;

    // ---------------------
    // Code for YouTube pages
    // ---------------------
    if (host.includes('youtube.com')) {
        const CSV_URL = 'https://raw.githubusercontent.com/188751671/Open_Genius_For_YoutubeMusic/refs/heads/main/videoID_To_GeniusURL.csv';
        const CHECK_INTERVAL = 2000; // 2 seconds
        let processedVideoId = null;

        const CACHE_KEY = 'geniusMapping';
        const CACHE_TIMESTAMP_KEY = 'lastRetrivalTime';
        const CACHE_LIFETIME = 10 * 60 * 1000; // 10 minutes

        function extractVideoId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('v');
        }

        function getCachedMapping(callback) {
            let cachedMapping = GM_getValue(CACHE_KEY, null);
            let timestamp = GM_getValue(CACHE_TIMESTAMP_KEY, 0);
            let now = Date.now();

            if (cachedMapping && (now - timestamp < CACHE_LIFETIME)) {
                console.log('Using Cached CSV');
                callback(cachedMapping);
            } else {
                GM_xmlhttpRequest({
                    method: 'GET',
                    url: CSV_URL,
                    onload: function(response) {
                        console.log('New Retrieved CSV:', response.responseText);
                        try {
                            const data = parseCSV(response.responseText, true);
                            GM_setValue(CACHE_KEY, data);
                            GM_setValue(CACHE_TIMESTAMP_KEY, now);
                            callback(data);
                        } catch (e) {
                            console.error('Error parsing CSV:', e);
                        }
                    },
                    onerror: function(error) {
                        console.error('Error fetching mapping:', error);
                    }
                });
            }
        }

        function parseCSV(csvString, skipHeader = false) {
            let rows = csvString
                .trim()
                .split("\n")
                .map(row => row.trim())
                .filter(row => row !== "")
                .map(row => row.split(",").map(item => item.trim()));

            return skipHeader ? rows.slice(1) : rows;
        }


        let geniusTab = null;
        function openGeniusPage(url) {
            if (geniusTab && !geniusTab.closed) {
                // Reuse the already opened Genius tab
                geniusTab.location.href = url;
                // return focus to the current (YouTube) tab
                window.focus();
            } else {
                // Open a new tab and store the reference
                geniusTab = window.open(url, 'genius_tab');
                window.focus();
            }
        }



        function getGeniusUrl(csvArray, videoId) {
            const foundRow = csvArray.find(row => row[0] === videoId);
            return foundRow ? `https://genius.com/${foundRow[1]}` : null;
        }

        function checkAndOpenLyrics() {
            let currentVideoId = extractVideoId();
            console.log('Retrieved YouTube ID:', currentVideoId);

            if (!currentVideoId || currentVideoId === processedVideoId) return;
            processedVideoId = currentVideoId;

            getCachedMapping(function(mapping) {
                const geniusUrl = getGeniusUrl(mapping, currentVideoId);
                if (geniusUrl) {
                    console.log('Retrieved Genius URL:', geniusUrl);
                    openGeniusPage(geniusUrl);
                } else {
                    console.warn('Video ID not found in CSV, not opening Genius.');
                }
            });
        }

        console.log('YouTube Script is starting...');
        setInterval(checkAndOpenLyrics, CHECK_INTERVAL);
    }

    // ---------------------
    // Code for Genius pages
    // ---------------------
    else if (host.includes('genius.com')) {
        const style = document.createElement('style');
        style.textContent = `
        /* 核心：把歌词区做成居中两列布局 */
        #lyrics-root {
            --ogm-sidebar-width: 300px;
            display: grid !important;
            grid-template-columns: minmax(0, 1fr) var(--ogm-sidebar-width) !important;
            gap: 24px !important;
            width: min(1200px, 94vw) !important;
            margin: 0 auto !important;
            align-items: start !important;
        }

        /* 左列：所有歌词块 + 歌词内广告等 */
        #lyrics-root > [data-lyrics-container="true"],
        #lyrics-root > [data-exclude-from-selection="true"],
        #lyrics-root > :not([data-lyrics-container="true"]):not([data-exclude-from-selection="true"]):not([class*="RightSidebar__Container"]):not([class*="LyricsFooter__Container"]) {
            grid-column: 1 / 2 !important;
            min-width: 0 !important;
        }

        /* 右列：所有右侧栏 */
        #lyrics-root > [class*="RightSidebar__Container"] {
            grid-column: 2 / 3 !important;
            width: var(--ogm-sidebar-width) !important;
            justify-self: end !important;
            min-width: 0 !important;
        }

        /* Footer 跨两列 */
        #lyrics-root > [class*="LyricsFooter__Container"] {
            grid-column: 1 / -1 !important;
        }

        /* 让歌词本体占满左列 */
        #lyrics-root [data-lyrics-container="true"] {
            max-width: none !important;
            width: 100% !important;
        }

        /* 隐藏页面顶部 banner 广告 */
        [id^="div-gpt-ad-desktop_song_combined_leaderboard"] {
            display: none !important;
        }

        /* 窄屏时改成单列 */
        @media (max-width: 1100px) {
            #lyrics-root {
            grid-template-columns: 1fr !important;
            width: min(720px, 94vw) !important;
            }
            #lyrics-root > [class*="RightSidebar__Container"] {
            grid-column: 1 / -1 !important;
            width: 100% !important;
            justify-self: stretch !important;
            }
        }
        `;
        document.head.appendChild(style);


        // ---------------------
        // Dark Mode Toggle
        // ---------------------
        let darkModeEnabled = GM_getValue('darkMode', false);

        const darkModeStyles = `
            body { background-color: #292929; color: #BAB7BA; }
            .header { background-color: #1f1f1f; }
            .jAzSMw, .cNCMgo { background-color: #333333!important; color: #BAB7BA; }
            .cNXXxk, .dddWnX, .hwdUNy { color: #BAB7BA !important; }
        `;


        const darkModeStyleElement = document.createElement('style');
        darkModeStyleElement.textContent = darkModeStyles;

        function applyDarkMode(state) {
            if (state) {
                document.head.appendChild(darkModeStyleElement);
            } else {
                if (darkModeStyleElement.parentNode) {
                    darkModeStyleElement.parentNode.removeChild(darkModeStyleElement);
                }
            }
        }

        applyDarkMode(darkModeEnabled);

        GM_registerMenuCommand(darkModeEnabled ? 'Disable Dark Mode' : 'Enable Dark Mode', () => {
            darkModeEnabled = !darkModeEnabled;
            GM_setValue('darkMode', darkModeEnabled);
            applyDarkMode(darkModeEnabled);
            location.reload();
        });
    }

})();
